<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relatório de Desempenho – CEBRASPE PF (120 itens)</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --card:#f6f7f9; --line:#e6e7ea; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:var(--bg); }
    header{ padding:20px; border-bottom:1px solid var(--line); }
    h1{ margin:0 0 6px 0; font-size:18px; }
    .sub{ color:var(--muted); font-size:13px; }
    .wrap{ padding:16px; max-width:1200px; margin:0 auto; }
    .controls{ display:grid; gap:10px; grid-template-columns:repeat(12,1fr); margin-bottom:14px; }
    .control{ grid-column:span 3; background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; }
    .control label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .control select,.control input{ width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px; }
    .actions{ grid-column:span 12; display:flex; gap:10px; flex-wrap:wrap; }
    button{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; font-weight:600; }
    button:hover{ background:#fafafa; }
    .kpis{ display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin:14px 0 18px; }
    .kpi{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; }
    .kpi .v{ font-size:20px; font-weight:800; }
    .kpi .t{ font-size:12px; color:var(--muted); margin-top:4px; }

    table{ width:100%; border-collapse:collapse; border:1px solid var(--line); border-radius:12px; overflow:hidden; margin-bottom:20px; }
    thead th{ text-align:left; font-size:12px; color:var(--muted); background:var(--card); padding:10px; border-bottom:1px solid var(--line); cursor:pointer; user-select:none; }
    tbody td{ padding:10px; border-bottom:1px solid var(--line); vertical-align:top; font-size:14px; }
    tbody tr:hover{ background:#fafafa; }
    .tag{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--line); }
    .certo{ background:#e9f7ef; border-color:#bfe7ce; }
    .errado{ background:#fdecec; border-color:#f3b9b9; }
    .branco{ background:#fff7e6; border-color:#ffdca3; }
    .anulado{ background:#eef2ff; border-color:#c7d2fe; }

    .perc-alta { color:#006400; font-weight:bold; }
    .perc-media { color:#d2691e; font-weight:bold; }
    .perc-baixa { color:#b22222; font-weight:bold; }

    .small{ font-size:12px; color:var(--muted); }
    .tabs { display:flex; border-bottom:1px solid var(--line); margin-bottom:16px; }
    .tab { padding:10px 20px; cursor:pointer; font-weight:600; color:var(--muted); }
    .tab.active { color:var(--fg); border-bottom:3px solid #0066cc; }
    .page { display:none; }
    .page.active { display:block; }

    footer{ padding:16px; color:var(--muted); font-size:12px; }
    @media (max-width: 980px){ .control{ grid-column:span 6; } .kpis{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width: 560px){ .control{ grid-column:span 12; } .kpis{ grid-template-columns:repeat(2,1fr); } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Relatório de Desempenho – 120 itens</h1>
      <div class="sub">Filtro por matéria/assunto/resultado + exportação CSV. (Branco não penaliza; Anulado não conta.)</div>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <div id="tabItens" class="tab active" role="tab" aria-selected="true">Itens</div>
      <div id="tabRanking" class="tab" role="tab" aria-selected="false">Ranking por Matéria</div>
    </div>

    <section id="pageItens" class="page active">
      <section class="controls">
        <div class="control">
          <label for="fMateria">Matéria</label>
          <select id="fMateria"></select>
        </div>
        <div class="control">
          <label for="fAssunto">Assunto</label>
          <select id="fAssunto"></select>
        </div>
        <div class="control">
          <label for="fResultado">Resultado</label>
          <select id="fResultado">
            <option value="">Todos</option>
            <option value="certo">certo</option>
            <option value="errado">errado</option>
            <option value="branco">branco</option>
            <option value="anulado">anulado</option>
          </select>
        </div>
        <div class="control">
          <label for="qSearch">Busca (nº, matéria, assunto)</label>
          <input id="qSearch" placeholder="ex.: Linux, 98, Direitos Humanos..." />
        </div>

        <div class="actions">
          <button id="btnReset" type="button">Limpar filtros</button>
          <button id="btnExport" type="button">Exportar CSV (itens filtrados)</button>
        </div>
      </section>

      <section class="kpis" id="kpis"></section>

      <section>
        <div class="small" id="hintSort">Clique no cabeçalho para ordenar (alternando asc/desc).</div>
        <table id="tbl">
          <thead>
            <tr>
              <th data-key="q">Q</th>
              <th data-key="materia">Matéria</th>
              <th data-key="assunto">Assunto</th>
              <th data-key="resultado">Resultado</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </section>

    <section id="pageRanking" class="page">
      <h2>Ranking por Matéria (geral – sem filtros)</h2>
      <p>Ordenado por acurácia sobre questões respondidas (acertos ÷ (acertos + erros)).</p>
      <table id="rankingTable">
        <thead>
          <tr>
            <th>Matéria</th>
            <th>Acertos</th>
            <th>Erros</th>
            <th>Brancos</th>
            <th>Anulados</th>
            <th>Respondidas</th>
            <th>Acurácia respondidas</th>
            <th>Aproveitamento válido</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="rankingBody"></tbody>
      </table>
    </section>
  </main>

  <footer class="wrap">
    Dica: publique este arquivo como <b>index.html</b> no GitHub Pages.
  </footer>

  <script>
    // ======= DADOS =======
    const data = [ /* ... seu array de 120 itens completo aqui ... */ 
      // (cole aqui o array data completo que você já tem – omiti por brevidade)
      // Exemplo: {q:1, materia:"Português", assunto:"Interpretação de texto", resultado:"certo"}, ...
    ];

    // ======= ESTADO =======
    let sortKey = "q";
    let sortDir = "asc";

    // ======= HELPERS =======
    const uniq = (arr) => [...new Set(arr)].sort((a,b)=>a.localeCompare(b,"pt-BR"));
    const tagClass = (r) => (r === "certo" ? "certo" : r === "errado" ? "errado" : r === "branco" ? "branco" : "anulado");

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function csvEscape(s){
      const v = String(s);
      if (/[,"\n]/.test(v)) return `"${v.replaceAll('"','""')}"`;
      return v;
    }

    function computeStats(rows){
      const stats = { total: rows.length, certo:0, errado:0, branco:0, anulado:0 };
      for(const r of rows){
        stats[r.resultado] = (stats[r.resultado]||0) + 1;
      }
      stats.validos = stats.total - stats.anulado;
      stats.respondidos = stats.validos - stats.branco;
      stats.acuracia = stats.respondidos > 0 ? (stats.certo / stats.respondidos) * 100 : 0;
      stats.aproveitamento = stats.validos > 0 ? (stats.certo / stats.validos) * 100 : 0;
      return stats;
    }

    // ======= RANKING POR MATÉRIA =======
    function computeRanking(){
      const matStats = {};
      data.forEach(d => {
        const m = d.materia;
        if (!matStats[m]) {
          matStats[m] = {certo:0, errado:0, branco:0, anulado:0, total:0};
        }
        matStats[m][d.resultado]++;
        matStats[m].total++;
      });

      const ranking = Object.entries(matStats).map(([materia, s]) => {
        const valido = s.total - s.anulado;
        const respondidas = valido - s.branco;
        const acuraciaResp = respondidas > 0 ? (s.certo / respondidas) * 100 : 0;
        const aproveitVal = valido > 0 ? (s.certo / valido) * 100 : 0;

        return {
          materia,
          certo: s.certo,
          errado: s.errado,
          branco: s.branco,
          anulado: s.anulado,
          respondidas,
          valido,
          acuraciaResp: acuraciaResp.toFixed(1),
          aproveitVal: aproveitVal.toFixed(1),
          total: s.total
        };
      });

      ranking.sort((a,b) => b.acuraciaResp - a.acuraciaResp);
      return ranking;
    }

    function renderRanking(){
      const ranking = computeRanking();
      const tbody = document.getElementById("rankingBody");
      tbody.innerHTML = ranking.map(r => {
        let classResp = r.acuraciaResp >= 70 ? "perc-alta" : r.acuraciaResp >= 40 ? "perc-media" : "perc-baixa";
        let classVal  = r.aproveitVal  >= 70 ? "perc-alta" : r.aproveitVal  >= 40 ? "perc-media" : "perc-baixa";

        return `
          <tr>
            <td>${escapeHtml(r.materia)}</td>
            <td>${r.certo}</td>
            <td>${r.errado}</td>
            <td>${r.branco}</td>
            <td>${r.anulado}</td>
            <td>${r.respondidas}</td>
            <td class="${classResp}">${r.acuraciaResp}%</td>
            <td class="${classVal}">${r.aproveitVal}%</td>
            <td>${r.total}</td>
          </tr>
        `;
      }).join("");
    }

    // ======= FUNÇÕES EXISTENTES (mantidas iguais) =======
    function populateFilters(){ /* ... seu código original ... */ }
    function updateAssuntoOptions(){ /* ... seu código original ... */ }
    function getFiltered(){ /* ... seu código original ... */ }
    function renderTable(rows){ /* ... seu código original ... */ }
    function renderKpis(rows){ /* ... seu código original ... */ }
    function refresh(){ /* ... seu código original ... */ }
    function resetFilters(){ /* ... seu código original ... */ }
    function toCsv(rows){ /* ... seu código original ... */ }
    function downloadText(filename, content, mime){ /* ... seu código original ... */ }
    function exportCsv(){ /* ... seu código original ... */ }
    function showPage(which){ /* ... seu código original ... */ }

    // ======= EVENTOS =======
    populateFilters();
    document.getElementById("fMateria").addEventListener("change", () => { updateAssuntoOptions(); refresh(); });
    document.getElementById("fAssunto").addEventListener("change", refresh);
    document.getElementById("fResultado").addEventListener("change", refresh);
    document.getElementById("qSearch").addEventListener("input", () => {
      window.clearTimeout(window.__t);
      window.__t = window.setTimeout(refresh, 120);
    });
    document.getElementById("btnReset").addEventListener("click", resetFilters);
    document.getElementById("btnExport").addEventListener("click", exportCsv);

    document.querySelectorAll("thead th[data-key]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.getAttribute("data-key");
        if (sortKey === key) sortDir = (sortDir === "asc" ? "desc" : "asc");
        else { sortKey = key; sortDir = "asc"; }
        refresh();
      });
    });

    document.getElementById("tabItens").addEventListener("click", ()=>showPage("itens"));
    document.getElementById("tabRanking").addEventListener("click", ()=>showPage("ranking"));

    // Renderiza ranking na primeira carga e ao trocar aba
    renderRanking();
    refresh();  // inicia na aba Itens
  </script>
</body>
</html>
